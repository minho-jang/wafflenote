# 와플노트 API 서버
크롬 확장 프로그램 "와플노트"와 통신하는 API 서버이다. <br>
와플노트 동작에 필요한 영상처리, 자연어처리 엔진들과 클라이언트를 연결하는 중간자 역할을 한다. 또한 DB를 조작하는 API는 크게 와플노트 사용자에 대한 API, 강의 노트와 슬라이드에 대한 API, 웹페이지 후기에 대한 API로 나눌 수 있다.

## APIs
### 1. 엔진 관련 API
와플노트 실행 중 호출하는 주요 API는 화면 전환 여부를 확인하는 API와 화면이 전환되었을 때 또는 와플노트를 종료시켰을 때 STT를 요청하는 API가 있다.
  - **POST /api/frame** : 이전 프레임 이미지와 현재 프레임 이미지를 영상처리를 통해 전환이 일어났는지 판단하는 API이다. 입력으로 들어온 이미지 파일 2개를 영상처리 엔진에게 전송하기 위해 문자열 형태로 변환한다. 이후에 실질적인 전환 여부는 영상처리 엔진에서 계산하며 결과가 false인 경우 그대로 false를 반환한다. 하지만 영상처리 결과가 true인 경우 화면이 전환되었으므로 현재 프레임 이미지로 새로운 슬라이드를 추가한다.
  - **POST /api/stt** : 오디오 데이터를 STT를 통해 텍스트로 변환하고 키워드를 분석하는 API이다. 입력으로 들어온 오디오 mp3 파일을 GCS(Google Cloud Storage)에 업로드 한다. GCP(Google Cloud Platform) Speech API를 호출하여 업로드된 파일을 텍스트로 변환시키고 해당 슬라이드에 저장한다. 또한 변환된 텍스트를 분석하여 키워드를 추출하여 저장한다. 저장하는 과정에서 와플노트가 실행 중이냐, 종료냐에 따라서 처리 과정이 다르다. 실행 중일 경우 해당 슬라이드에 스크립트와 키워드를 저장하고, 종료일 경우 해당 슬라이드에 스크립트와 키워드를 저장한 후에 강의 전체에 대해서 분석을 실행한다. 강의 분석은 자연어처리 엔진의 API를 호출하는 방식이며 분석 결과들도 저장한다.

### 2. 사용자 관련 API
와플노트 크롬 확장 프로그램 또는 웹 서버에서 사용자 관련 처리를 위해 호출하는 API이다.
  - **POST /signin** : 아이디와 비밀번호 정보를 통해 해당 사용자 정보가 DB에 존재하면 true를 반환하고 세션(Session) 정보를 생성하며, 없으면 false를 반환한다. 비밀번호는 해시(Hash)되어 DB에 저장되어 있으므로, 먼저 아이디가 존재하는지 확인한 후에 사용자의 salt 값과 비밀번호를 해시하여 문자열을 비교한다. 세션 정보는 서버 측에 저장되어 누가 API 요청을 했는지 인증하는데 사용된다.
  - **POST /signup** : 사용자 등록에 필요한 정보들을 받아와 DB에 저장한다. 입력된 아이디가 존재할 경우 false를 반환한다. 이 때 salt 값도 임의로 생성하고 비밀번호를 이 salt 값과 함께 해시하여, salt 값과 해시된 비밀번호를 DB에 저장한다.  
  - **POST /signout** : 세션 정보를 제거하고 true를 반환한다.
  - **POST /find-id** : 회원가입할 때 입력한 정보(이름, 휴대전화번호)를 통해 아이디를 반환한다.
  - **POST /find-password** : 회원가입할 때 입력한 아이디(이메일)로 인증번호를 전송한다.
  - **POST /change-password** : POST /find-password에서 전송한 인증번호를 확인한 후에 일치하면 비밀번호를 변경한다.
  - **POST /verify-email** : 회원가입할 때 입력한 아이디(이메일)로 인증번호를 전송한다.
  - **POST /verify-code** : POST /verify-email에서 전송한 인증번호를 확인한 후에 일치하면 true를 반환한다.
  - **POST /user-info** : 현재 세션 정보에 해당하는 사용자 정보를 가져온다.

### 3. 강의 노트 관련 API
와플노트 크롬 확장 프로그램 강의 노트 관련 처리를 위해 호출하는 API이다. 필요한 경우 엔진 API를 호출하여 결과 값을 처리한다.
  - **GET /note** : 현재 사용자의 강의 노트 정보를 최근 순으로 가져온다.
  - **GET /note/recently** : 현재 사용자의 가장 최근 강의 노트 정보를 가져온다.
  - **GET /note/:noteid** : 특정 강의 노트 정보를 가져온다.
  - **GET /note/:noteid/result** : 특정 강의 노트의 분석 결과 정보를 가져온다. 분석 결과는 호출 때마다 매번 현재 강의 노트의 정보를 확인하여 새로 분석한다. 이는 사용자가 강의 노트의 스크립트를 수정할 경우 분석 결과가 변해야하기 때문에 매번 분석하는 과정을 거친다.
  - **POST /note** : 강의 노트를 생성한다. 이는 맨 처음 와플노트의 강의 시작을 실행할 경우 먼저 강의 노트를 생성한 후에, 첫 화면 이미지를 해당 노트의 첫 번째 슬라이드 대표 이미지로 저장한다.
  - **POST /note/:noteid/title** : 특정 강의 노트의 제목을 수정한다.
  - **POST /note/:noteid/delete** : 특정 강의 노트를 삭제한다.

### 4. 슬라이드 관련 API 
와플노트 크롬 확장 프로그램 강의 노트 관련 처리를 위해 호출하는 API이다. 필요한 경우 스토리지에 접근하여 업로드 및 다운로드를 한다.
  - **GET /slide/all/:noteid** : 특정 강의 노트의 슬라이드 리스트를 가져온다.
  - **GET /slide/:slideid** : 특정 슬라이드 정보를 가져온다.
  - **GET /slide/:slideid/origin-image** : 특정 슬라이드의 대표이미지를 가져온다. DB에는 경로 형태로 저장되어 있으며 해당 경로를 통해 스토리지에서 파일을 다운로드한다.
  - **GET /slide/:slideid/audio** : 특정 슬라이드의 오디오를 가져온다. DB에는 경로 형태로 저장되어 있으며 해당 경로를 통해 스토리지에서 파일을 다운로드한다.
  - **POST /slide/:noteid** : 특정 강의 노트에 슬라이드를 추가한다. 
  - **POST /slide/:slideid/delete** : 특정 슬라이드를 삭제한다.
  - **POST /slide/:slideid/replace** : 특정 슬라이드를 수정한다. 교체하는 방식으로 수정하므로 하나의 필드를 수정하고 싶더라도 그 외에 필드에 대한 데이터도 함께 필요하다.

### 5. 웹페이지 후기 관련 API
와플노트 웹페이지에서 후기 게시판의 조회, 삽입, 수정, 삭제를 처리한다.
  - **GET /review** : 작성된 후기를 최근 순서대로 가져온다.
  - **POST /review** : 후기를 등록한다.
  - **POST /review/delete** : 후기를 삭제한다.

## Getting started
```
npm install
node app
```
